
# export_licenses.py
A tool to extract registered Fortinet devices from a FortiCare account and list their associated license entitlements and contract codes

Also can generate a list of contract moves to make to balance license assignments (experimental)

## Requirements
 - A FortiCare support account with devices registered
 - A FortiCare account ID (will look like a GUID e.g. ABCD1234-A12B-1234-ABAB-12345678910A)
 - A FortiCare account API token (looks like a long password)
 - requests, argparse and csv standard python modules installed
 
 Some (public) instructions from Fortinet to generate these are here: https://community.fortinet.com/t5/FortiCloud-Products/Technical-Tip-API-how-to-retrieve-list-of-registered-units-for/ta-p/194760
 
 ## Usage
 Move the included credentials.py.example file to credentials.py and fill out the account ID (username) and the API token (password)
 E.g.
 
     username = "ABCD1234-A12B-1234-ABAB-12345678910A"
     password = "MyLongAutoGeneratedPasswordHere"
     
  Run the file
  
    python export_licenses.py <generate_contract_move|export_assignments> [--output-file output_csv_filename] [--account-id account_id] [--api-token api_token]

### Running notes

 - When running with the action 'export_assignments', all assets on the FortiCare support portal will be saved to a CSV, with all contract codes and entitlement details included
 - When running with the action 'generate_move_actions', it wil save a CSV with a recommended set of contract moves to balance all assets. <br>
 - Warning! You will have to get Fortinet TAC to actually do this for you, and it should be carefully checked.<br>
 - It requires correct mappings (required) and equal SKU options (not always required) to be specified for best results.

 Where the required arguments for all actions are:
 | Argument      | Needed value                         | Required when                                 | Example value                        |
|---------------|--------------------------------------|-----------------------------------------------|--------------------------------------|
| action        | Either export_assignments or generate_move_actions | Always | export_assignments
| --account-id  | The FortiCare account ID             | When username not specified in credentials.py | ABCD1234-A12B-1234-ABAB-12345678910A |
| --api-token   | The FortiCare API token              | When password not specified in credentials.py | MyLongAutoGeneratedPasswordHere      |
    
  You can run without the file without any arguments if username and password are specified in credentials.py
    
## generate_move_actions options
When using the generate_move_actions options, the following options are available
 | Argument      | Needed value                         | Required when                                 | Example value                        |
|---------------|--------------------------------------|-----------------------------------------------|--------------------------------------|
| --input-contracts | An export from forti_license_parser.py | Optional                              | licenses.csv                           |
| --output-file | A location to save the CSV report to | Not required                                  | Output.csv                           |
| -e<br> --equal-sku  | One sku to consider equal to another SKU.<br> Format is SKU1:SKU2.<br> Can be specified multiple times         | Optional | 	FC-00-0000F-111-01-12:FCX-00-0000E-111-01-12 |
| -m<br>--mapping  | Specifies what products should consider a balanced license assignment<br> Example format is 'FortiGate 60F:FC-00-0000F-111-01-12:3' (FortiGate 60F should have 3 FC-00-0000F-111-01-12 licenses).<br> Can be specified multiple times           | Required | FortiGate 60F:FC-00-0000F-111-01-12:3      |

## export_assignments options
When using the generate_move_actions options, the following options are available
 | Argument      | Needed value                         | Required when                                 | Example value                        |
|---------------|--------------------------------------|-----------------------------------------------|--------------------------------------|
| --output-file | A location to save the CSV report to | Not required                                  | Output.csv                           |

## Output (export_assignments)

You will get a CSV formatted like this:
| serialNumber | registrationDate    | productModel    | contracts                                                                                    | SKUs                                                                                   | Entitlements                                                                                                                                                                                 |
|--------------|---------------------|-----------------|----------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| FTK-Serial1  | 2022-06-18T12:42:58 | FortiGate 1800F | 5999WK089692<br>8913EK551047<br>9563BD247362<br>7956DC526535<br>3490UG308959<br>8710UE134473 | FC-10-SKU-1<br>FC-10-SKU-2<br>FC-10-SKU-3<br>FC-10-SKU-4<br>FC-10-SKU-5<br>FC-10-SKU-6 | Description of entitlement 1<br>Description of entitlement 2<br>Description of entitlement 3<br>Description of entitlement 4<br>Description of entitlement 5<br>Description of entitlement 6 |
                                                                                                                                                                                                                                                                                                                                                                 
## Output (generate_move_actions)

You will get a CSV formatted like this:
| originalSN | model    | contractNumber    | sku                                                                                   | toSN                                                                                  | Description                                                                                                                                                                                 |
|--------------|---------------------|-----------------|----------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| FGT60FTKABC12345  | FortiGate 60F | AAAAAAAAAAAA | FC-10-0060F-100-01-12 | FGT60FTAAAABBBB | Description here |
                                                         